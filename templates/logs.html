{% extends "base.html" %}

{% block content %}
<style>
/* Log display styling */
#logContent {
    line-height: 1.4;
    padding: 0;
    margin: 0;
}

/* Alternating row colors */
.log-line {
    padding: 2px 8px;
    margin: 0;
    display: block;
    border: none;
}

.log-line:nth-child(odd) {
    background-color: #ffffff;
}

.log-line:nth-child(even) {
    background-color: #f8f9fa;
}

/* Search term highlighting */
.search-highlight {
    background-color: #ffeb3b;
    color: #000;
    font-weight: bold;
    padding: 1px 2px;
    border-radius: 2px;
}

/* Search results specific styling */
.search-result-line {
    padding: 4px 8px;
    margin: 0;
    display: block;
    border-left: 3px solid #007bff;
}

.search-result-line:nth-child(odd) {
    background-color: #f8f9ff;
}

.search-result-line:nth-child(even) {
    background-color: #ffffff;
}

/* Line number styling in search results */
.line-number {
    color: #6c757d;
    font-weight: bold;
    margin-right: 8px;
}

/* Search header styling */
.search-header {
    background-color: #e3f2fd;
    padding: 8px;
    border-radius: 4px;
    margin-bottom: 8px;
    border-left: 4px solid #2196f3;
}
</style>
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-file-alt"></i> Log Viewer</h5>
            </div>
            <div class="card-body">
                <!-- Search Section -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-search"></i> Search Logs</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="searchTerm" class="form-label">Search for:</label>
                                        <input type="text" id="searchTerm" class="form-control" placeholder="Enter search term..." />
                                    </div>
                                    <div class="col-md-2">
                                        <label for="maxResults" class="form-label">Max results:</label>
                                        <select id="maxResults" class="form-select">
                                            <option value="50">50</option>
                                            <option value="100" selected>100</option>
                                            <option value="200">200</option>
                                            <option value="500">500</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="caseSensitive">
                                            <label class="form-check-label" for="caseSensitive">
                                                Case sensitive
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-flex gap-2">
                                            <button id="searchBtn" class="btn btn-info">
                                                <i class="fas fa-search"></i> Search
                                            </button>
                                            <button id="clearSearchBtn" class="btn btn-outline-secondary">
                                                <i class="fas fa-times"></i> Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="logLines" class="form-label">Lines to show:</label>
                        <select id="logLines" class="form-select">
                            <option value="20">20</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                        </select>
                    </div>
                    <div class="col-md-9">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button id="refreshBtn" class="btn btn-primary">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                            <button id="followBtn" class="btn btn-success">
                                <i class="fas fa-play"></i> Start Following
                            </button>
                            <button id="stopFollowBtn" class="btn btn-danger" style="display: none;">
                                <i class="fas fa-stop"></i> Stop Following
                            </button>
                            <button id="clearBtn" class="btn btn-secondary">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Log File Info -->
                <div id="logInfo" class="alert alert-info" style="display: none;">
                    <strong>File:</strong> <span id="logFilePath"></span>
                </div>

                <!-- Log Content -->
                <div id="logContainer" class="border rounded" style="height: 500px; overflow-y: auto; background-color: #f8f9fa;">
                    <div id="logContent" class="mb-0" style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 12px;"></div>
                </div>

                <!-- Status -->
                <div id="logStatus" class="mt-2">
                    <small class="text-muted">Select a log type and click refresh to view logs</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let followInterval = null;
let isFollowing = false;

document.addEventListener('DOMContentLoaded', function() {
    const logLines = document.getElementById('logLines');
    const refreshBtn = document.getElementById('refreshBtn');
    const followBtn = document.getElementById('followBtn');
    const stopFollowBtn = document.getElementById('stopFollowBtn');
    const clearBtn = document.getElementById('clearBtn');
    const logContent = document.getElementById('logContent');
    const logInfo = document.getElementById('logInfo');
    const logFilePath = document.getElementById('logFilePath');
    const logStatus = document.getElementById('logStatus');
    const logContainer = document.getElementById('logContainer');
    
    // Search elements
    const searchTerm = document.getElementById('searchTerm');
    const maxResults = document.getElementById('maxResults');
    const caseSensitive = document.getElementById('caseSensitive');
    const searchBtn = document.getElementById('searchBtn');
    const clearSearchBtn = document.getElementById('clearSearchBtn');

    function updateStatus(message, isError = false) {
        logStatus.innerHTML = `<small class="${isError ? 'text-danger' : 'text-muted'}">${message}</small>`;
    }

    function scrollToBottom() {
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function highlightSearchTerm(text, searchTerm, caseSensitive = false) {
        if (!searchTerm) return escapeHtml(text);
        
        const escaped = escapeHtml(text);
        const flags = caseSensitive ? 'g' : 'gi';
        const regex = new RegExp(escapeHtml(searchTerm).replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), flags);
        
        return escaped.replace(regex, match => `<span class="search-highlight">${match}</span>`);
    }

    function formatLogLines(content, isSearchResult = false, searchTerm = '', caseSensitive = false) {
        if (!content) return '';
        
        const lines = content.split('\n');
        const lineClass = isSearchResult ? 'search-result-line' : 'log-line';
        
        return lines.map(line => {
            if (line.trim() === '') return '<div class="' + lineClass + '">&nbsp;</div>';
            
            let formattedLine = line;
            if (isSearchResult && searchTerm) {
                formattedLine = highlightSearchTerm(line, searchTerm, caseSensitive);
            } else {
                formattedLine = escapeHtml(line);
            }
            
            return `<div class="${lineClass}">${formattedLine}</div>`;
        }).join('');
    }

    function loadLogs() {
        const lines = logLines.value;
        
        updateStatus('Loading logs...');
        
        fetch(`/api/logs?lines=${lines}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const content = data.content || 'No log entries found';
                    logContent.innerHTML = formatLogLines(content, false);
                    logFilePath.textContent = data.file;
                    logInfo.style.display = 'block';
                    updateStatus(`Loaded ${lines} lines from ${data.file}`);
                    scrollToBottom();
                } else {
                    logContent.innerHTML = formatLogLines('Error loading logs: ' + data.error, false);
                    updateStatus('Error loading logs: ' + data.error, true);
                }
            })
            .catch(error => {
                logContent.innerHTML = formatLogLines('Network error: ' + error, false);
                updateStatus('Network error: ' + error, true);
            });
    }

    function startFollowing() {
        if (isFollowing) return;
        
        isFollowing = true;
        followBtn.style.display = 'none';
        stopFollowBtn.style.display = 'inline-block';
        
        // Initial load
        loadLogs();
        
        // Set up polling for new log entries
        followInterval = setInterval(() => {
            const lines = logLines.value;
            
            fetch(`/api/logs/follow?lines=${lines}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.content) {
                            logContent.innerHTML = formatLogLines(data.content, false);
                            scrollToBottom();
                        }
                        updateStatus(`Following ${data.file} (auto-refresh every 3s)`);
                    }
                })
                .catch(error => {
                    updateStatus('Follow error: ' + error, true);
                });
        }, 3000);
        
        updateStatus('Started following logs...');
    }

    function stopFollowing() {
        if (!isFollowing) return;
        
        isFollowing = false;
        followBtn.style.display = 'inline-block';
        stopFollowBtn.style.display = 'none';
        
        if (followInterval) {
            clearInterval(followInterval);
            followInterval = null;
        }
        
        updateStatus('Stopped following logs');
    }

    function clearLogs() {
        logContent.innerHTML = '';
        logInfo.style.display = 'none';
        updateStatus('Log display cleared');
    }

    function searchLogs() {
        const query = searchTerm.value.trim();
        if (!query) {
            alert('Please enter a search term');
            return;
        }
        
        const maxRes = maxResults.value;
        const caseSens = caseSensitive.checked;
        
        updateStatus('Searching logs...');
        
        const params = new URLSearchParams({
            q: query,
            max_results: maxRes,
            case_sensitive: caseSens.toString()
        });
        
        fetch(`/api/logs/search?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displaySearchResults(data);
                } else {
                    logContent.innerHTML = formatLogLines('Search error: ' + data.error, false);
                    updateStatus('Search error: ' + data.error, true);
                }
            })
            .catch(error => {
                logContent.innerHTML = formatLogLines('Network error: ' + error, false);
                updateStatus('Network error: ' + error, true);
            });
    }

    function displaySearchResults(data) {
        if (data.matches.length === 0) {
            const noResultsMsg = `No matches found for "${data.search_term}"`;
            logContent.innerHTML = formatLogLines(noResultsMsg, false);
            logFilePath.textContent = data.file;
            logInfo.style.display = 'block';
            updateStatus(`No matches found for "${data.search_term}"`);
            return;
        }
        
        // Create search header
        const headerInfo = `Search Results for "${data.search_term}" (${data.total_matches} matches)
Case sensitive: ${data.case_sensitive ? 'Yes' : 'No'}`;
        
        let htmlContent = `<div class="search-header">${escapeHtml(headerInfo)}</div>`;
        
        // Add search results with highlighting
        data.matches.forEach(match => {
            const lineNumberSpan = `<span class="line-number">Line ${match.line_number}:</span>`;
            const highlightedContent = highlightSearchTerm(match.content, data.search_term, data.case_sensitive);
            htmlContent += `<div class="search-result-line">${lineNumberSpan}${highlightedContent}</div>`;
        });
        
        if (data.total_matches >= data.max_results) {
            htmlContent += `<div class="search-result-line"><em>... (showing first ${data.max_results} results)</em></div>`;
        }
        
        logContent.innerHTML = htmlContent;
        logFilePath.textContent = data.file;
        logInfo.style.display = 'block';
        updateStatus(`Found ${data.total_matches} matches for "${data.search_term}"`);
        scrollToBottom();
    }

    function clearSearch() {
        searchTerm.value = '';
        caseSensitive.checked = false;
        loadLogs(); // Return to normal log view
    }

    // Event listeners
    refreshBtn.addEventListener('click', loadLogs);
    followBtn.addEventListener('click', startFollowing);
    stopFollowBtn.addEventListener('click', stopFollowing);
    clearBtn.addEventListener('click', clearLogs);
    
    // Search event listeners
    searchBtn.addEventListener('click', searchLogs);
    clearSearchBtn.addEventListener('click', clearSearch);
    
    // Enter key to search
    searchTerm.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchLogs();
        }
    });
    
    // Auto-refresh when lines change during following
    logLines.addEventListener('change', function() {
        if (isFollowing) {
            stopFollowing();
            setTimeout(startFollowing, 500);
        }
    });

    // Load initial logs
    loadLogs();
});
</script>
{% endblock %}